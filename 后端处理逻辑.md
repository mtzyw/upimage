ğŸ“˜ å›¾åƒå¢å¼º SaaS é¡¹ç›®å®Œæ•´æµç¨‹æ–‡æ¡£ï¼ˆå« Freepik API Key è½®æ¢æœºåˆ¶ï¼‰

## ğŸ—ï¸ ç°æœ‰ç³»ç»Ÿæ¶æ„æ€»ç»“

### æ•°æ®åº“æ¶æ„ (Supabase)
| è¡¨å | ç”¨é€” | å…³é”®å­—æ®µ |
|------|------|----------|
| `users` | ç”¨æˆ·ç®¡ç† | `id`, `role`, `stripe_customer_id` |
| `usage` | ç§¯åˆ†ä½™é¢ | `one_time_credits_balance`, `subscription_credits_balance`, `balance_jsonb` |
| `credit_logs` | ç§¯åˆ†è®°å½• | `amount`, `type`, `notes`, `user_id` |
| `pricing_plans` | ä»·æ ¼è®¡åˆ’ | `benefits_jsonb`ï¼ˆå«ç§¯åˆ†é…ç½®ï¼‰ |
| `subscriptions` | è®¢é˜…ç®¡ç† | `status`, `current_period_end`, `plan_id` |
| `orders` | è®¢å•è®°å½• | `order_type`, `amount_total`, `related_order_id` |

### å­˜å‚¨ç³»ç»Ÿ (Cloudflare R2)
- **æ–‡ä»¶ç»“æ„**: `users/{userId}/original-xxx.png`, `users/{userId}/optimized-{taskId}.png`
- **è®¿é—®æ–¹å¼**: CDN é€šè¿‡ `R2_PUBLIC_URL` å…¬å¼€è®¿é—®
- **ä¸Šä¼ æœºåˆ¶**: Presigned URLï¼ˆ10åˆ†é’Ÿæœ‰æ•ˆæœŸï¼‰+ æœåŠ¡ç«¯ç›´ä¼ 

### é™æµç³»ç»Ÿ (Upstash Redis)
- **é™æµç­–ç•¥**: æ»‘åŠ¨çª—å£ç®—æ³•ï¼Œæ”¯æŒå¤šç»´åº¦é™åˆ¶
- **å½“å‰åº”ç”¨**: Newsletter è®¢é˜…é™åˆ¶ï¼ˆæ¯æ—¥æœ€å¤§æäº¤æ¬¡æ•°ï¼‰
- **é…ç½®çµæ´»**: æŒ‰æ—¶é—´å•ä½ï¼ˆs/m/h/dï¼‰å’Œè¯·æ±‚æ¬¡æ•°ç»„åˆ

### ç§¯åˆ†ç®¡ç†ç³»ç»Ÿ
- **æ‰£å‡æœºåˆ¶**: `deductCredits()` å‡½æ•° + `deduct_credits_and_log` æ•°æ®åº“å‡½æ•°
- **æˆäºˆæœºåˆ¶**: Stripe Webhook è§¦å‘è‡ªåŠ¨ç§¯åˆ†æˆäºˆ
- **åŒé‡ç§¯åˆ†**: ä¸€æ¬¡æ€§ç§¯åˆ†ï¼ˆè´­ä¹°è·å¾—ï¼‰+ è®¢é˜…ç§¯åˆ†ï¼ˆæœˆåº¦/å¹´åº¦åˆ†é…ï¼‰

## ğŸ§± å¢å¼ºåæŠ€æœ¯ç»„æˆ
| æ¨¡å— | æŠ€æœ¯ | æ–°å¢ç‰¹æ€§ |
|------|------|----------|
| å­˜å‚¨ | Cloudflare R2ï¼ˆåŸå›¾ & ä¼˜å›¾ï¼‰ | å¤ç”¨ç°æœ‰ Presigned URL æœºåˆ¶ |
| å›¾åƒå¢å¼º | Freepik Magnific API | **API Key è½®æ¢æœºåˆ¶** |
| çŠ¶æ€è¿½è¸ª & é™æµ | Upstash Redis | ç§¯åˆ†æ£€æŸ¥ + ä»»åŠ¡çŠ¶æ€ç¼“å­˜ |
| ç”¨æˆ·é™åˆ¶ | ç°æœ‰ç§¯åˆ†æ‰£å‡ç³»ç»Ÿ | é›†æˆç°æœ‰ç§¯åˆ†æœºåˆ¶ |
| åç«¯æ¡†æ¶ | Next.js API Routes | å¤ç”¨ç°æœ‰æ¶æ„ |
| æ•°æ®åº“ | Supabase | æ–°å¢ä»»åŠ¡è®°å½•è¡¨ + API Key ç®¡ç†è¡¨ |

## ğŸ§­ ç”¨æˆ·æµç¨‹æ¦‚è§ˆ

```mermaid
graph TD
A[ç”¨æˆ·ä¸Šä¼ å›¾ç‰‡] --> B[ç§¯åˆ†ä½™é¢æ£€æŸ¥]
B --> |ä½™é¢ä¸è¶³| C[è¿”å›ç§¯åˆ†ä¸è¶³é”™è¯¯]
B --> |ä½™é¢å……è¶³| D[è¯·æ±‚ä¸Šä¼ å‡­è¯]
D --> E[ä¸Šä¼ åŸå›¾åˆ° R2]
E --> F[æ‰£å‡ç§¯åˆ† + å‘èµ· Freepik å¢å¼ºè¯·æ±‚]
F --> G[API Key è½®æ¢é€‰æ‹©å¯ç”¨ Key]
G --> H[Freepik å¼‚æ­¥å¤„ç†ï¼ˆWebhook å›è°ƒï¼‰]
H --> I[åç«¯è·å–ä¼˜åŒ–å›¾ â†’ ä¸Šä¼ å› R2]
I --> J[å­˜ Redis & æ•°æ®åº“ â†’ çŠ¶æ€å˜æ›´]
J --> K[å‰ç«¯è½®è¯¢çŠ¶æ€]
K --> L[å±•ç¤ºä¼˜åŒ–åçš„ CDN å›¾åƒé“¾æ¥]
```

## âœ… æ­¥éª¤è¯¦è§£ï¼ˆé›†æˆç°æœ‰ç³»ç»Ÿï¼‰

### â‘  ç§¯åˆ†ä½™é¢æ£€æŸ¥
**æ¥å£**: `GET /api/user/benefits`ï¼ˆç°æœ‰ï¼‰

**è¿”å›å†…å®¹**:
```json
{
  "success": true,
  "data": {
    "totalAvailableCredits": 100,
    "oneTimeCreditsBalance": 50,
    "subscriptionCreditsBalance": 50,
    "activePlanId": "plan_xxx"
  }
}
```

**é‡ç‚¹**: 
- å¤ç”¨ç°æœ‰ `getClientUserBenefits()` å‡½æ•°
- å‰ç«¯æ£€æŸ¥ `totalAvailableCredits >= å›¾åƒå¢å¼ºæ¶ˆè€—ç§¯åˆ†`

### â‘¡ è·å–ä¸Šä¼ åœ°å€ Presigned URL
**æ¥å£**: `POST /api/upload/presigned-url`ï¼ˆç°æœ‰ï¼‰

**å‚æ•°**:
```json
{
  "fileName": "image.jpg",
  "contentType": "image/jpeg"
}
```

**è¿”å›å†…å®¹**:
```json
{
  "presignedUrl": "https://r2.presigned.url",
  "publicObjectUrl": "https://cdn.imgenhancer.ai/users/{userId}/original-xxx.png",
  "key": "users/{userId}/original-xxx.png"
}
```

**é‡ç‚¹**: 
- å¤ç”¨ç°æœ‰ `generateUserPresignedUploadUrl()` å‡½æ•°
- è·¯å¾„è‡ªåŠ¨åŒ…å« `userid-{userId}` ç”¨æˆ·éš”ç¦»

### â‘¢ ä¸Šä¼ åŸå›¾è‡³ R2ï¼ˆå‰ç«¯ï¼‰
```typescript
await fetch(presignedUrl, {
  method: 'PUT',
  body: file,
  headers: {
    'Content-Type': file.type,
    // æ³¨æ„ï¼šR2 éœ€è¦è®¾ç½®å…¬å¼€è¯»æƒé™ï¼Œç¡®ä¿ Freepik èƒ½è®¿é—®
  }
})
```

### â‘£ å‘èµ·å›¾åƒå¢å¼ºè¯·æ±‚
**æ¥å£**: `POST /api/enhance/start`

**å‚æ•°**:
```json
{
  "r2Key": "users/123/original-xxx.png",
  "scaleFactor": "4x",
  "optimizedFor": "standard",
  "prompt": "optional enhancement prompt",
  "creativity": 0,
  "hdr": 0,
  "resemblance": 0,
  "fractality": 0,
  "engine": "automatic"
}
```

**åç«¯æ“ä½œæµç¨‹**:

1. **ç”¨æˆ·è®¤è¯ä¸ç§¯åˆ†æ£€æŸ¥**
```typescript
// è·å–ç”¨æˆ·ä¿¡æ¯
const { data: { user } } = await supabase.auth.getUser()

// æ£€æŸ¥ç§¯åˆ†ä½™é¢
const benefits = await getUserBenefits(user.id)
const requiredCredits = calculateRequiredCredits(scaleFactor) // 2x=1, 4x=2, 8x=4, 16x=8

if (benefits.totalAvailableCredits < requiredCredits) {
  return apiResponse.badRequest('ç§¯åˆ†ä½™é¢ä¸è¶³')
}
```

2. **API Key è½®æ¢æœºåˆ¶**
```typescript
// è·å–å¯ç”¨çš„ API Key
const apiKey = await getAvailableFreepikApiKey()
if (!apiKey) {
  return apiResponse.error('æš‚æ—¶æ— æ³•å¤„ç†è¯·æ±‚ï¼Œè¯·ç¨åé‡è¯•')
}
```

3. **ä» R2 ä¸‹è½½å¹¶è½¬æ¢å›¾ç‰‡**
```typescript
// ä» CDN ä¸‹è½½åŸå›¾
const imageUrl = `${process.env.R2_PUBLIC_URL}/${r2Key}`
const response = await fetch(imageUrl)
const buffer = await response.arrayBuffer()
const base64Image = Buffer.from(buffer).toString('base64')
```

4. **æ‰£å‡ç§¯åˆ†**
```typescript
// æ‰£å‡ç§¯åˆ†ï¼ˆä½¿ç”¨ç°æœ‰å‡½æ•°ï¼‰
const deductResult = await deductCredits(requiredCredits, `å›¾åƒå¢å¼º ${scaleFactor} å¤„ç†`)
if (!deductResult.success) {
  return apiResponse.error('ç§¯åˆ†æ‰£å‡å¤±è´¥')
}
```

5. **æäº¤ Freepik è¯·æ±‚**
```typescript
const freepikResponse = await fetch('https://api.freepik.com/v1/ai/image-upscaler', {
  method: 'POST',
  headers: {
    'x-freepik-api-key': apiKey.key,
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({
    image: base64Image,
    scale_factor: scaleFactor,
    optimized_for: optimizedFor,
    webhook_url: `${process.env.NEXT_PUBLIC_SITE_URL}/api/webhook/freepik`,
    // ... å…¶ä»–å‚æ•°
  })
})

const { data } = await freepikResponse.json()
const taskId = data.task_id
```

6. **è®°å½•ä»»åŠ¡çŠ¶æ€**
```typescript
// Redis ç¼“å­˜ä»»åŠ¡çŠ¶æ€
await redis.set(`task:${taskId}:status`, 'processing', { ex: 3600 })
await redis.set(`task:${taskId}:user_id`, user.id, { ex: 3600 })
await redis.set(`task:${taskId}:api_key_id`, apiKey.id, { ex: 3600 })

// æ•°æ®åº“è®°å½•ä»»åŠ¡
await supabase.from('image_enhancement_tasks').insert({
  id: taskId,
  user_id: user.id,
  status: 'processing',
  r2_original_key: r2Key,
  scale_factor: scaleFactor,
  api_key_id: apiKey.id,
  credits_consumed: requiredCredits
})
```

**è¿”å›å†…å®¹**:
```json
{
  "success": true,
  "data": {
    "taskId": "freepik_task_xxx",
    "status": "processing",
    "creditsConsumed": 2,
    "remainingCredits": 98
  }
}
```

### â‘¤ Webhook å›è°ƒå¤„ç†ï¼ˆFreepik å¼‚æ­¥é€šçŸ¥ï¼‰
**æ¥å£**: `POST /api/webhook/freepik`

**æ“ä½œæµç¨‹**:

1. **éªŒè¯ Webhook ç­¾å**ï¼ˆå®‰å…¨æªæ–½ï¼‰
2. **çŠ¶æ€å¤„ç†**
```typescript
if (status === "DONE") {
  // ä¸‹è½½ Freepik ä¼˜åŒ–åçš„å›¾åƒ
  const optimizedImageResponse = await fetch(result.image_url)
  const optimizedBuffer = await optimizedImageResponse.arrayBuffer()
  
  // ä¸Šä¼ åˆ° R2 optimized æ–‡ä»¶å¤¹
  const optimizedKey = `users/${userId}/optimized-${taskId}.${getImageExtension(result.image_url)}`
  await serverUploadFile({
    data: Buffer.from(optimizedBuffer),
    contentType: 'image/jpeg', // æˆ–æ ¹æ®å®é™…æ ¼å¼
    key: optimizedKey
  })
  
  // ç”Ÿæˆ CDN åœ°å€
  const cdnUrl = `${process.env.R2_PUBLIC_URL}/${optimizedKey}`
  
  // æ›´æ–° Redis çŠ¶æ€
  await redis.set(`task:${taskId}:status`, 'completed', { ex: 86400 })
  await redis.set(`task:${taskId}:cdn_url`, cdnUrl, { ex: 86400 })
  
  // æ›´æ–°æ•°æ®åº“
  await supabase.from('image_enhancement_tasks')
    .update({
      status: 'completed',
      r2_optimized_key: optimizedKey,
      cdn_url: cdnUrl,
      completed_at: new Date().toISOString()
    })
    .eq('id', taskId)
    
  // é‡Šæ”¾ API Keyï¼ˆå¢åŠ å¯ç”¨æ¬¡æ•°æˆ–é‡ç½®çŠ¶æ€ï¼‰
  await releaseApiKey(apiKeyId)
}

if (status === "FAILED") {
  // ä»»åŠ¡å¤±è´¥ï¼Œè€ƒè™‘é€€å›ç§¯åˆ†
  await redis.set(`task:${taskId}:status`, 'failed', { ex: 86400 })
  
  // å¯é€‰ï¼šé€€å›ç§¯åˆ†ç»™ç”¨æˆ·
  const taskInfo = await supabase.from('image_enhancement_tasks')
    .select('user_id, credits_consumed')
    .eq('id', taskId)
    .single()
    
  if (taskInfo.data) {
    await supabaseAdmin.rpc('grant_one_time_credits_and_log', {
      p_user_id: taskInfo.data.user_id,  
      p_credits_to_add: taskInfo.data.credits_consumed,
      p_related_order_id: null
    })
  }
}
```

### â‘¥ ç”¨æˆ·å‰ç«¯è½®è¯¢ä»»åŠ¡çŠ¶æ€
**æ¥å£**: `GET /api/enhance/status?taskId=xxx`

**è¿”å›**:
```json
{
  "success": true,
  "data": {
    "status": "completed",
    "cdnUrl": "https://cdn.imgenhancer.ai/users/123/optimized-xxx.jpg",
    "originalUrl": "https://cdn.imgenhancer.ai/users/123/original-xxx.jpg"
  }
}
```

## ğŸ”‘ API Key è½®æ¢æœºåˆ¶è¯¦è§£

### æ•°æ®åº“è¡¨ç»“æ„
**æ–°è¡¨**: `freepik_api_keys`
```sql
CREATE TABLE freepik_api_keys (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  key TEXT NOT NULL UNIQUE,
  name VARCHAR(100), -- ä¾¿äºè¯†åˆ«ï¼Œå¦‚ "key-001"
  daily_limit INTEGER DEFAULT 100, -- æ¯æ—¥é™åˆ¶æ¬¡æ•°
  used_today INTEGER DEFAULT 0, -- ä»Šæ—¥å·²ç”¨æ¬¡æ•°
  last_reset_date DATE DEFAULT CURRENT_DATE, -- æœ€åé‡ç½®æ—¥æœŸ
  is_active BOOLEAN DEFAULT TRUE, -- æ˜¯å¦å¯ç”¨
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- ç´¢å¼•ä¼˜åŒ–
CREATE INDEX idx_freepik_api_keys_active ON freepik_api_keys(is_active, used_today, daily_limit);
```

### è½®æ¢ç­–ç•¥å®ç°
```typescript
// lib/freepik/api-key-manager.ts
export async function getAvailableFreepikApiKey() {
  const today = new Date().toISOString().split('T')[0]
  
  // é‡ç½®æ˜¨å¤©çš„è®¡æ•°å™¨
  await supabaseAdmin
    .from('freepik_api_keys')
    .update({ 
      used_today: 0, 
      last_reset_date: today 
    })
    .neq('last_reset_date', today)
  
  // è·å–å¯ç”¨çš„ API Keyï¼ˆä»Šæ—¥ä½¿ç”¨æ¬¡æ•°æœªè¾¾ä¸Šé™ï¼‰
  const { data: availableKeys } = await supabaseAdmin
    .from('freepik_api_keys')
    .select('*')
    .eq('is_active', true)
    .filter('used_today', 'lt', 'daily_limit')
    .order('used_today', { ascending: true }) // ä¼˜å…ˆä½¿ç”¨ä½¿ç”¨æ¬¡æ•°å°‘çš„
    .limit(1)
  
  if (!availableKeys || availableKeys.length === 0) {
    return null // æ‰€æœ‰ Key éƒ½è¾¾åˆ°é™åˆ¶
  }
  
  const selectedKey = availableKeys[0]
  
  // å¢åŠ ä½¿ç”¨è®¡æ•°
  await supabaseAdmin
    .from('freepik_api_keys')
    .update({ 
      used_today: selectedKey.used_today + 1,
      updated_at: new Date().toISOString()
    })
    .eq('id', selectedKey.id)
  
  return {
    id: selectedKey.id,
    key: selectedKey.key,
    remaining: selectedKey.daily_limit - selectedKey.used_today - 1
  }
}

export async function releaseApiKey(keyId: string) {
  // å¦‚æœä»»åŠ¡å¤±è´¥ï¼Œå¯ä»¥è€ƒè™‘å‡å°‘ä½¿ç”¨è®¡æ•°
  // æˆ–è€…æ·»åŠ å…¶ä»–é‡Šæ”¾é€»è¾‘
  await supabaseAdmin
    .from('freepik_api_keys')
    .update({ updated_at: new Date().toISOString() })
    .eq('id', keyId)
}
```

### ç›‘æ§å’Œç®¡ç†
**ç®¡ç†å‘˜é¢æ¿**: `/dashboard/freepik-keys`
- æŸ¥çœ‹æ‰€æœ‰ API Key çš„ä½¿ç”¨æƒ…å†µ
- æ·»åŠ /åˆ é™¤/æš‚åœ API Key
- æŸ¥çœ‹æ¯æ—¥ä½¿ç”¨ç»Ÿè®¡
- è®¾ç½®æ¯ä¸ª Key çš„é™åˆ¶æ¬¡æ•°

**ç›‘æ§æŒ‡æ ‡**:
- æ¯ä¸ª Key çš„æ¯æ—¥ä½¿ç”¨ç‡
- å¤±è´¥ç‡ç»Ÿè®¡
- Key è€—å°½é¢„è­¦

### ç¯å¢ƒå˜é‡é…ç½®
```env
# Freepik API Keys é…ç½®ï¼ˆæ”¯æŒå¤šä¸ªkeyï¼Œç”¨é€—å·åˆ†éš”ï¼‰
FREEPIK_API_KEYS="key1,key2,key3"
FREEPIK_DEFAULT_DAILY_LIMIT=100
```

## ğŸ“¦ æ–°å¢æ•°æ®åº“è¡¨ç»“æ„

### image_enhancement_tasks è¡¨
```sql
CREATE TABLE image_enhancement_tasks (
  id TEXT PRIMARY KEY, -- Freepik task_id
  user_id UUID REFERENCES users(id) NOT NULL,
  status TEXT NOT NULL DEFAULT 'processing', -- processing, completed, failed
  r2_original_key TEXT NOT NULL,
  r2_optimized_key TEXT,
  cdn_url TEXT,
  scale_factor TEXT NOT NULL, -- 2x, 4x, 8x, 16x
  optimized_for TEXT DEFAULT 'standard',
  prompt TEXT,
  creativity INTEGER DEFAULT 0,
  hdr INTEGER DEFAULT 0,
  resemblance INTEGER DEFAULT 0,
  fractality INTEGER DEFAULT 0,
  engine TEXT DEFAULT 'automatic',
  api_key_id UUID REFERENCES freepik_api_keys(id),
  credits_consumed INTEGER NOT NULL,
  error_message TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  completed_at TIMESTAMPTZ,
  
  -- ç´¢å¼•
  INDEX idx_image_tasks_user_status (user_id, status),
  INDEX idx_image_tasks_created (created_at DESC)
);
```

## ğŸ” ç§¯åˆ†æ¶ˆè€—è§„åˆ™

| æ”¾å¤§å€æ•° | æ¶ˆè€—ç§¯åˆ† | å¤„ç†æ—¶é—´é¢„ä¼° |
|----------|----------|--------------|
| 2x | 1 ç§¯åˆ† | 30-60ç§’ |
| 4x | 2 ç§¯åˆ† | 1-2åˆ†é’Ÿ |
| 8x | 4 ç§¯åˆ† | 2-5åˆ†é’Ÿ |
| 16x | 8 ç§¯åˆ† | 5-10åˆ†é’Ÿ |

**ç§¯åˆ†è®¡ç®—å‡½æ•°**:
```typescript
export function calculateRequiredCredits(scaleFactor: string): number {
  const scaleMap = {
    '2x': 1,
    '4x': 2, 
    '8x': 4,
    '16x': 8
  }
  return scaleMap[scaleFactor] || 1
}
```

## ğŸ“Œ æ ¸å¿ƒå·¥å…·å‡½æ•°ï¼ˆåŸºäºç°æœ‰ç³»ç»Ÿï¼‰

### å¤ç”¨ç°æœ‰å‡½æ•°
- `generateUserPresignedUploadUrl()` - R2 ä¸Šä¼ å‡­è¯ç”Ÿæˆ
- `deductCredits()` - ç§¯åˆ†æ‰£å‡
- `getUserBenefits()` - è·å–ç”¨æˆ·ç§¯åˆ†ä½™é¢
- `checkRateLimit()` - Redis é™æµæ£€æŸ¥
- `serverUploadFile()` - æœåŠ¡ç«¯æ–‡ä»¶ä¸Šä¼ 

### æ–°å¢ä¸“ç”¨å‡½æ•°
```typescript
// lib/freepik/utils.ts
export async function convertR2ImageToBase64(cdnUrl: string): Promise<string>

export async function uploadOptimizedImageToR2(
  buffer: Buffer, 
  userId: string, 
  taskId: string
): Promise<{ key: string; url: string }>

export async function setTaskStatus(
  taskId: string, 
  status: string, 
  additionalData?: Record<string, any>
): Promise<void>

export async function getTaskStatus(taskId: string): Promise<TaskStatus | null>
```

## âœ… æ€»ç»“ï¼šä¸ç°æœ‰ç³»ç»Ÿé›†æˆçš„å…³é”®ç‚¹

| é˜¶æ®µ | é›†æˆç‚¹ | é‡ç‚¹ç»†èŠ‚ |
|------|--------|----------|
| ç”¨æˆ·è®¤è¯ | å¤ç”¨ç°æœ‰ Supabase Auth | æ— éœ€é¢å¤–è®¤è¯æœºåˆ¶ |
| ç§¯åˆ†æ£€æŸ¥ | è°ƒç”¨ç°æœ‰ `getUserBenefits()` | æ£€æŸ¥ `totalAvailableCredits` |
| æ–‡ä»¶ä¸Šä¼  | å¤ç”¨ç°æœ‰ R2 Presigned URL | è·¯å¾„è‡ªåŠ¨åŒ…å«ç”¨æˆ·éš”ç¦» |
| ç§¯åˆ†æ‰£å‡ | è°ƒç”¨ç°æœ‰ `deductCredits()` | è‡ªåŠ¨è®°å½•åˆ° `credit_logs` è¡¨ |
| é™æµæ§åˆ¶ | å¤ç”¨ç°æœ‰ Redis é™æµæœºåˆ¶ | å¯æŒ‰ç”¨æˆ·IDæˆ–IPé™æµ |
| API Keyç®¡ç† | æ–°å¢è½®æ¢æœºåˆ¶ | æ•°æ®åº“ç®¡ç†å¤šä¸ªKeyçš„ä½¿ç”¨çŠ¶æ€ |
| çŠ¶æ€è¿½è¸ª | Redis + æ–°å¢ä»»åŠ¡è¡¨ | çŸ­æœŸç¼“å­˜ + é•¿æœŸå­˜å‚¨ |
| Webhookå®‰å…¨ | ç­¾åéªŒè¯ | é˜²æ­¢ä¼ªé€ è¯·æ±‚ |
| é”™è¯¯å¤„ç† | ä»»åŠ¡å¤±è´¥æ—¶é€€å›ç§¯åˆ† | ä¿è¯ç”¨æˆ·ä½“éªŒ |

**éƒ¨ç½²æ³¨æ„äº‹é¡¹**:
1. ç¡®ä¿ R2 æ–‡ä»¶è®¾ç½®å…¬å¼€è¯»æƒé™ï¼Œè®© Freepik èƒ½è®¿é—®
2. é…ç½®å¤šä¸ª Freepik API Key å¹¶è®¾ç½®åˆç†çš„æ¯æ—¥é™åˆ¶
3. è®¾ç½® Webhook URL çš„å®‰å…¨éªŒè¯æœºåˆ¶
4. ç›‘æ§ API Key ä½¿ç”¨æƒ…å†µï¼ŒåŠæ—¶è¡¥å……æ–°Key
5. åˆç†è®¾ç½® Redis TTLï¼Œå¹³è¡¡æ€§èƒ½å’Œå­˜å‚¨æˆæœ¬